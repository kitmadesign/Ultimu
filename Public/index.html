<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#18181b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema RPG - Ordem Paranormal</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="../assets/css/componentes.css">
</head>
<body>
  <!-- Modal de PermissÃµes -->
  <div id="permissionsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; margin: 20px; background: var(--card);">
      <div class="card-header">
        <h2 class="card-title">ğŸ”’ PermissÃµes NecessÃ¡rias</h2>
      </div>
      <div style="padding: 20px;">
        <p>Para uma experiÃªncia completa no sistema RPG, precisamos das seguintes permissÃµes:</p>
        
        <div class="permission-item" style="display: flex; align-items: center; gap: 12px; margin: 16px 0; padding: 12px; border: 1px solid var(--bs-border-color); border-radius: 8px;">
          <div style="font-size: 1.5rem;">ğŸµ</div>
          <div>
            <strong>Ãudio</strong>
            <p style="margin: 4px 0 0 0; font-size: 0.9rem; color: var(--muted);">
              Para efeitos sonoros e mÃºsica ambiente
            </p>
          </div>
          <div id="audioStatus" style="margin-left: auto; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; background: var(--danger);">
            Pendente
          </div>
        </div>

        <div class="permission-item" style="display: flex; align-items: center; gap: 12px; margin: 16px 0; padding: 12px; border: 1px solid var(--bs-border-color); border-radius: 8px;">
          <div style="font-size: 1.5rem;">ğŸ’¾</div>
          <div>
            <strong>Armazenamento</strong>
            <p style="margin: 4px 0 0 0; font-size: 0.9rem; color: var(--muted);">
              Para salvar suas fichas e configuraÃ§Ãµes
            </p>
          </div>
          <div id="storageStatus" style="margin-left: auto; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; background: var(--success);">
            Concedida
          </div>
        </div>

        <div class="permission-item" style="display: flex; align-items: center; gap: 12px; margin: 16px 0; padding: 12px; border: 1px solid var(--bs-border-color); border-radius: 8px;">
          <div style="font-size: 1.5rem;">ğŸ””</div>
          <div>
            <strong>NotificaÃ§Ãµes</strong>
            <p style="margin: 4px 0 0 0; font-size: 0.9rem; color: var(--muted);">
              Para alertas durante as sessÃµes
            </p>
          </div>
          <div id="notificationStatus" style="margin-left: auto; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; background: var(--warning);">
            Opcional
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button id="requestPermissions" class="btn btn-primary" style="flex: 1;">
            Conceder PermissÃµes
          </button>
          <button id="skipPermissions" class="btn btn-ghost" style="flex: 1;">
            Pular por enquanto
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="text-center mb-6">
      <h1>ğŸ® Sistema de RPG</h1>
      <p class="text-center">Ordem Paranormal - ExperiÃªncia Imersiva</p>
    </div>
    
    <div class="grid grid-2">
      <!-- Card do Mestre -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ‘‘ Mestre</h2>
        </div>
        <p>Controle a sessÃ£o e gerencie o combate.</p>
        
        <div class="form-group mt-4">
          <label class="form-label">UsuÃ¡rio Mestre</label>
          <input type="text" id="mestre-username" class="form-input" placeholder="mestre" value="mestre">
        </div>
        <div class="form-group">
          <label class="form-label">Senha Mestre</label>
          <input type="password" id="mestre-password" class="form-input" placeholder="075107" value="075107">
        </div>
        
        <button class="btn btn-primary w-full" onclick="fazerLoginMestre()">
          ğŸ” Acessar Painel do Mestre
        </button>

        <div id="mensagem-mestre" class="login-message"></div>
      </div>
      
      <!-- Card do Jogador -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ² Jogador</h2>
        </div>
        <p>Entre na sessÃ£o com sua ficha.</p>
        
        <div class="form-group mt-4">
          <label class="form-label">UsuÃ¡rio</label>
          <input type="text" id="jogador-username" class="form-input" placeholder="Nome de usuÃ¡rio">
        </div>
        <div class="form-group">
          <label class="form-label">Senha</label>
          <input type="password" id="jogador-password" class="form-input" placeholder="Sua senha">
        </div>
        
        <button class="btn btn-primary w-full" onclick="fazerLoginJogador()">
          ğŸ® Acessar Ficha do Jogador
        </button>

        <div class="text-center mt-3">
          <a href="javascript:void(0)" onclick="mostrarRegistro()" class="btn btn-ghost btn-sm">
            ğŸ“ Criar nova conta
          </a>
        </div>

        <div id="mensagem-jogador" class="login-message"></div>
      </div>
    </div>
    
    <!-- FormulÃ¡rio de Registro (inicialmente oculto) -->
    <div id="form-registro" class="card mt-4" style="display: none;">
      <div class="card-header">
        <h2 class="card-title">ğŸ“ Criar Conta de Jogador</h2>
      </div>
      <div class="form-group">
        <label class="form-label">UsuÃ¡rio</label>
        <input type="text" id="reg-username" class="form-input" placeholder="Nome de usuÃ¡rio">
      </div>
      <div class="form-group">
        <label class="form-label">Nome de exibiÃ§Ã£o (opcional)</label>
        <input type="text" id="reg-display" class="form-input" placeholder="Como quer ser chamado">
      </div>
      <div class="form-group">
        <label class="form-label">Senha</label>
        <input type="password" id="reg-password" class="form-input" placeholder="Crie uma senha">
      </div>
      
      <div class="grid grid-2 gap-2">
        <button class="btn btn-primary" onclick="fazerRegistro()">
          Criar Conta
        </button>
        <button class="btn btn-ghost" onclick="ocultarRegistro()">
          Cancelar
        </button>
      </div>

      <div id="mensagem-registro" class="login-message"></div>
    </div>
    
    <div class="card mt-6">
      <div class="card-header">
        <h2 class="card-title">ğŸ“‹ InstruÃ§Ãµes</h2>
      </div>
      <div class="grid grid-2">
        <div>
          <h4>ğŸ§ Para Jogadores</h4>
          <ul style="color: var(--muted); line-height: 1.6;">
            <li>Use fones de ouvido para experiÃªncia imersiva</li>
            <li>Mantenha esta pÃ¡gina aberta durante a sessÃ£o</li>
            <li>Configure seu Ã¡udio corretamente</li>
          </ul>
        </div>
        <div>
          <h4>ğŸ”’ PermissÃµes</h4>
          <ul style="color: var(--muted); line-height: 1.6;">
            <li>Ãudio: Para efeitos sonoros</li>
            <li>Armazenamento: Para salvar progresso</li>
            <li>NotificaÃ§Ãµes: Para alertas importantes</li>
          </ul>
          <button class="btn btn-sm btn-ghost mt-2" onclick="showPermissionsModal()">
            Gerenciar PermissÃµes
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sistema de Gerenciamento de PermissÃµes
    class PermissionManager {
      constructor() {
        this.permissions = {
          audio: false,
          storage: true,
          notifications: false
        };
        this.storageKey = 'rpgSystemPermissions';
        this.loadPermissions();
      }

      loadPermissions() {
        try {
          const saved = localStorage.getItem(this.storageKey);
          if (saved) {
            this.permissions = { ...this.permissions, ...JSON.parse(saved) };
          }
        } catch (e) {
          console.warn('NÃ£o foi possÃ­vel carregar permissÃµes salvas:', e);
        }
      }

      savePermissions() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.permissions));
          sessionStorage.setItem(this.storageKey, JSON.stringify(this.permissions));
        } catch (e) {
          console.warn('NÃ£o foi possÃ­vel salvar permissÃµes:', e);
        }
      }

      async requestAudioPermission() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          await audioContext.resume();
          
          const testAudio = new Audio();
          testAudio.src = 'data:audio/wav;base64,UklGRnoAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoAAAC';
          testAudio.volume = 0;
          
          await testAudio.play();
          testAudio.pause();
          
          this.permissions.audio = true;
          this.savePermissions();
          return true;
        } catch (error) {
          console.warn('PermissÃ£o de Ã¡udio negada:', error);
          this.permissions.audio = false;
          this.savePermissions();
          return false;
        }
      }

      async requestNotificationPermission() {
        if (!('Notification' in window)) {
          console.warn('Este navegador nÃ£o suporta notificaÃ§Ãµes');
          return false;
        }

        if (Notification.permission === 'granted') {
          this.permissions.notifications = true;
          this.savePermissions();
          return true;
        }

        if (Notification.permission === 'denied') {
          console.warn('PermissÃ£o de notificaÃ§Ãµes foi negada anteriormente');
          return false;
        }

        try {
          const permission = await Notification.requestPermission();
          this.permissions.notifications = permission === 'granted';
          this.savePermissions();
          return this.permissions.notifications;
        } catch (error) {
          console.warn('Erro ao solicitar permissÃ£o de notificaÃ§Ãµes:', error);
          return false;
        }
      }

      checkStoragePermission() {
        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          this.permissions.storage = true;
          this.savePermissions();
          return true;
        } catch (e) {
          console.warn('Armazenamento nÃ£o disponÃ­vel:', e);
          this.permissions.storage = false;
          this.savePermissions();
          return false;
        }
      }

      async requestAllPermissions() {
        const results = {
          audio: await this.requestAudioPermission(),
          storage: this.checkStoragePermission(),
          notifications: await this.requestNotificationPermission()
        };

        this.updateUI();
        return results;
      }

      updateUI() {
        const audioStatus = document.getElementById('audioStatus');
        const storageStatus = document.getElementById('storageStatus');
        const notificationStatus = document.getElementById('notificationStatus');

        if (audioStatus) {
          audioStatus.textContent = this.permissions.audio ? 'Concedida' : 'Pendente';
          audioStatus.style.background = this.permissions.audio ? 'var(--success)' : 'var(--danger)';
        }

        if (storageStatus) {
          storageStatus.textContent = this.permissions.storage ? 'Concedida' : 'Bloqueada';
          storageStatus.style.background = this.permissions.storage ? 'var(--success)' : 'var(--danger)';
        }

        if (notificationStatus) {
          notificationStatus.textContent = this.permissions.notifications ? 'Concedida' : 'Opcional';
          notificationStatus.style.background = this.permissions.notifications ? 'var(--success)' : 'var(--warning)';
        }
      }

      getPermissions() {
        return { ...this.permissions };
      }
    }

    const permissionManager = new PermissionManager();

    // FunÃ§Ãµes de Login
    async function fazerLoginMestre() {
      const username = document.getElementById('mestre-username').value;
      const password = document.getElementById('mestre-password').value;
      const mensagem = document.getElementById('mensagem-mestre');

      try {
        mostrarMensagem(mensagem, 'â³ Verificando credenciais...', 'loading');

        const response = await fetch('/api/login-mestre', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          localStorage.setItem('rpg_token', data.token);
          localStorage.setItem('rpg_user_role', 'mestre');
          localStorage.setItem('rpg_user_name', data.user.displayName);
          
          mostrarMensagem(mensagem, 'âœ… Acesso concedido! Redirecionando...', 'success');
          
          setTimeout(() => {
            window.location.href = '/mestre/dashboard.html';
          }, 1000);
        } else {
          mostrarMensagem(mensagem, 'âŒ ' + (data.error || 'Credenciais invÃ¡lidas'), 'error');
        }
      } catch (error) {
        console.error('Erro no login:', error);
        mostrarMensagem(mensagem, 'âŒ Erro de conexÃ£o com o servidor', 'error');
      }
    }

    async function fazerLoginJogador() {
      const username = document.getElementById('jogador-username').value;
      const password = document.getElementById('jogador-password').value;
      const mensagem = document.getElementById('mensagem-jogador');

      try {
        mostrarMensagem(mensagem, 'â³ Verificando credenciais...', 'loading');

        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          localStorage.setItem('rpg_token', data.token);
          localStorage.setItem('rpg_user_role', 'jogador');
          localStorage.setItem('rpg_user_name', data.user.displayName);
          
          mostrarMensagem(mensagem, 'âœ… Login realizado! Redirecionando...', 'success');
          
          setTimeout(() => {
            window.location.href = '/jogador/dashboard.html';
          }, 1000);
        } else {
          mostrarMensagem(mensagem, 'âŒ ' + (data.error || 'Credenciais invÃ¡lidas'), 'error');
        }
      } catch (error) {
        console.error('Erro no login:', error);
        mostrarMensagem(mensagem, 'âŒ Erro de conexÃ£o com o servidor', 'error');
      }
    }

    async function fazerRegistro() {
      const username = document.getElementById('reg-username').value;
      const displayName = document.getElementById('reg-display').value || username;
      const password = document.getElementById('reg-password').value;
      const mensagem = document.getElementById('mensagem-registro');

      if (!username || !password) {
        mostrarMensagem(mensagem, 'âŒ Preencha todos os campos obrigatÃ³rios', 'error');
        return;
      }

      try {
        mostrarMensagem(mensagem, 'â³ Criando sua conta...', 'loading');

        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, displayName, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          mostrarMensagem(mensagem, 'âœ… Conta criada com sucesso! FaÃ§a login agora.', 'success');
          
          document.getElementById('reg-username').value = '';
          document.getElementById('reg-display').value = '';
          document.getElementById('reg-password').value = '';
          
          setTimeout(() => {
            ocultarRegistro();
            mostrarMensagem(mensagem, '', 'success');
          }, 2000);
        } else {
          mostrarMensagem(mensagem, 'âŒ ' + (data.error || 'Erro ao criar conta'), 'error');
        }
      } catch (error) {
        console.error('Erro no registro:', error);
        mostrarMensagem(mensagem, 'âŒ Erro de conexÃ£o com o servidor', 'error');
      }
    }

    function mostrarMensagem(elemento, texto, tipo) {
      elemento.textContent = texto;
      elemento.style.display = texto ? 'block' : 'none';
      
      elemento.classList.remove('login-success', 'login-error', 'login-loading');
      
      if (tipo === 'success') {
        elemento.classList.add('login-success');
      } else if (tipo === 'error') {
        elemento.classList.add('login-error');
      } else if (tipo === 'loading') {
        elemento.classList.add('login-loading');
      }
    }

    function mostrarRegistro() {
      document.getElementById('form-registro').style.display = 'block';
    }

    function ocultarRegistro() {
      document.getElementById('form-registro').style.display = 'none';
      document.getElementById('mensagem-registro').style.display = 'none';
    }

    function showPermissionsModal() {
      const modal = document.getElementById('permissionsModal');
      permissionManager.updateUI();
      modal.style.display = 'flex';
    }

    function hidePermissionsModal() {
      const modal = document.getElementById('permissionsModal');
      modal.style.display = 'none';
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      const hasSeenPermissions = sessionStorage.getItem('hasSeenPermissions');
      if (!hasSeenPermissions) {
        setTimeout(showPermissionsModal, 1000);
        sessionStorage.setItem('hasSeenPermissions', 'true');
      }

      const requestBtn = document.getElementById('requestPermissions');
      if (requestBtn) {
        requestBtn.addEventListener('click', async function() {
          requestBtn.textContent = 'Solicitando...';
          requestBtn.disabled = true;
          
          await permissionManager.requestAllPermissions();
          
          requestBtn.textContent = 'PermissÃµes Concedidas!';
          setTimeout(() => {
            hidePermissionsModal();
            requestBtn.textContent = 'Conceder PermissÃµes';
            requestBtn.disabled = false;
          }, 1500);
        });
      }

      const skipBtn = document.getElementById('skipPermissions');
      if (skipBtn) {
        skipBtn.addEventListener('click', hidePermissionsModal);
      }

      document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (document.getElementById('form-registro').style.display === 'block') {
            fazerRegistro();
          } else if (document.activeElement.closest('.card:first-child')) {
            fazerLoginMestre();
          } else {
            fazerLoginJogador();
          }
        }
      });

      permissionManager.updateUI();
    });

    window.permissionManager = permissionManager;
  </script>

  <style>
    .permission-item {
      transition: all 0.3s ease;
    }

    .permission-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .modal {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .w-full {
      width: 100%;
    }

    .login-message {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
      display: none;
    }

    .login-success {
      background: var(--success);
      color: white;
    }

    .login-error {
      background: var(--danger);
      color: white;
    }

    .login-loading {
      background: var(--warning);
      color: white;
    }
  </style>
</body>
</html>